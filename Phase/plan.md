# 開発計画 (Development Plan)

プロジェクトのフェーズ定義と詳細タスクリストです。
各タスクは `Phase X.Y.Z` の粒度で管理し、実装時の迷いを排除します。

## Phase 1: 企画・設計 (Planning) - v0.1.0 [COMPLETED]
- [x] **1.1. 要件定義**
    - [x] 1.1.1. システム仕様書 (`system_spec.md`) の作成（日本語化・詳細化）
    - [x] 1.1.2. デュアルモード（自動受付/文書スキャン）の振り分けロジック定義
- [x] **1.2. 技術選定**
    - [x] 1.2.1. Pythonバックエンド構成決定 (FastAPI, pystray, OpenCV)
    - [x] 1.2.2. Chrome拡張機能構成決定 (Manifest V3)
- [x] **1.3. UI/UX設計**
    - [x] 1.3.1. タスクトレイ・メニューの仕様策定
    - [x] 1.3.2. 拡張機能設定画面・ウィザード機能の仕様策定

---

## Phase 2: プロトタイプ開発 (Prototyping MVP) - v0.2.0
**目標**: 「設定不要で、起動すればスキャンして電子カルテにアップロードされる」コア機能の動作実証。

### 2.1. バックエンド基盤構築 (Backend Foundation)
- [ ] **2.1.1. Pythonプロジェクトセットアップ**
    - `venv` 作成、`requirements.txt` 定義 (fastapi, uvicorn, opencv-python, pystray, pillow, azure-openai, python-dotenv, **cv2-enumerate-cameras**)。
- [ ] **2.1.2. タスクトレイ常駐アプリの実装**
    - `pystray` を使用し、起動時にアイコンを表示。
    - 「終了」メニューの実装。コンソールウィンドウなしでの起動 (`.pyw` 拡張子等) 検証。
- [ ] **2.1.3. APIサーバー実装**
    - FastAPI の基本エンドポイント実装 (`GET /status`, `GET /cameras`)。
    - 別スレッドで API サーバーを起動する仕組みの実装。

### 2.2. スキャン・画像処理ロジック (Scanning Logic)
- [ ] **2.2.1. カメラ制御と動体検知**
    - OpenCV でカメラ映像を取得。
    - `BackgroundSubtractorMOG2` による動体検知実装。
- [ ] **2.2.2. Ecoモードの実装**
    - 待機時 (低FPS) と検知時 (高FPS) のステートマシン実装。
    - 10秒タイムアウトによるモード遷移。
- [ ] **2.2.3. 静止画キャプチャと保存**
    - 静止判定ロジック (1.5秒静止)。
    - 画像の一時保存 (`./temp` への書き出し)。

### 2.3. AI解析ロジック (AI Processing)
- [ ] **2.3.1. Azure OpenAI 接続**
    - クライアント実装。JSONモードでの患者ID抽出プロンプト実装。
- [ ] **2.3.2. ダミーモード実装**
    - 開発中にAPI課金を防ぐため、ダミーIDを返すモック機能の実装。

### 2.4. Chrome拡張機能 MVP (Frontend MVP)
- [ ] **2.4.1. Manifest V3 基盤作成**
    - `manifest.json`, `background.js`, `content.js`, `popup.html` の雛形作成。
- [ ] **2.4.2. ポーリング通信の実装**
    - `background.js` から `GET /check_new_scan` を定期ポーリング。
- [ ] **2.4.3. アップロード・ナビゲーション (ハードコード)**
    - テスト用サイト (または指定電子カルテ) へのファイルアップロード処理の実装。
    - ※この段階ではURLやセレクタはコードに直書きでOK。

---

## Phase 3: 本開発 (Development) - v0.5.0
**目標**: ユーザーが設定可能にし、エラー処理や使い勝手を製品レベルにする。

### 3.1. バックエンド機能拡張
- [ ] **3.1.1. 設定APIの実装**
    - `.env` の読み書き機能、または `config.json` 管理への移行検討。
- [ ] **3.1.2. 振り分けロジックの実装**
    - 面積・個数判定による「受付モード」と「文書モード」の自動判定ロジック。
    - 音声通知機能 (`winsound` または `pygame` 等) の実装。

### 3.2. タスクトレイ・メニュー完成
- [ ] **3.2.1. カメラ選択メニュー**
    - 利用可能カメラ一覧の動的生成と切り替え処理。
- [ ] **3.2.2. Ecoモード設定メニュー**
    - 待機時間の変更機能。

### 3.3. Chrome拡張機能 UI実装
- [ ] **3.3.1. 設定ページ (Options UI) の実装**
    - 電子カルテURL、セレクタの設定フォーム。
- [ ] **3.3.2. かんたん設定ウィザード**
    - 画面上の要素クリックでセレクタを取得する `interactive_setup.js` の実装。
- [ ] **3.3.3. 手入力モーダル**
    - エラー時の画像表示とInputフォームのオーバーレイ実装。

---

## Phase 4: 検証・リリース (Verification & Release) - v1.0.0
**目標**: 安定性の確保と配布準備。

### 4.1. 結合テスト
- [ ] **4.1.1. End-to-End テスト**
    - 実際の紙を置いてから、電子カルテ画面に反映されるまでの通しテスト。
- [ ] **4.1.2. 異常系テスト**
    - ネット切断時、カメラ切断時、AIエラー時の挙動確認。

### 4.2. 配布準備
- [ ] **4.2.1. 起動スクリプト整備**
    - `install.bat` (依存ライブラリインストール + スタートアップ登録)。
    - `start.bat` (アプリ起動)。
- [ ] **4.2.2. マニュアル作成**
    - インストール手順書、トラブルシューティング。
