# 開発計画 (Development Plan)

プロジェクトのフェーズ定義と詳細タスクリストです。
各タスクは `Phase X.Y.Z` の粒度で管理し、実装時の迷いを排除します。

## Phase 1: 企画・設計 (Planning) - v0.1.0 [COMPLETED]
- [x] **1.1. 要件定義**
    - [x] 1.1.1. システム仕様書 (`system_spec.md`) の作成（日本語化・詳細化）
    - [x] 1.1.2. デュアルモード（自動受付/文書スキャン）の振り分けロジック定義
- [x] **1.2. 技術選定**
    - [x] 1.2.1. Pythonバックエンド構成決定 (FastAPI, pystray, OpenCV)
    - [x] 1.2.2. Chrome拡張機能構成決定 (Manifest V3)
- [x] **1.3. UI/UX設計**
    - [x] 1.3.1. タスクトレイ・メニューの仕様策定
    - [x] 1.3.2. 拡張機能設定画面・ウィザード機能の仕様策定

---

## Phase 2: プロトタイプ開発 (Prototyping MVP) - v0.2.0
**目標**: 「設定不要で、起動すればスキャンして電子カルテにアップロードされる」コア機能の動作実証。

### 2.1. バックエンド基盤構築 (Backend Foundation)
- [ ] **2.1.1. Pythonプロジェクトセットアップ**
    - `venv` 作成、`requirements.txt` 定義 (fastapi, uvicorn, opencv-python, pystray, pillow, easyocr, python-dotenv, **cv2-enumerate-cameras**)。
- [ ] **2.1.2. タスクトレイ常駐アプリの実装**
    - `pystray` を使用し、起動時にアイコンを表示。
    - 「終了」メニューの実装。コンソールウィンドウなしでの起動 (`.pyw` 拡張子等) 検証。
> **Status**: [進行中] 2.1, 2.2 完了 (検証済み)

#### 2.1. バックエンド基盤 (Backend Foundation) [完了 - 検証済]
- **2.1.1. プロジェクト構成**: `venv`, `requirements.txt` の整備。
- **2.1.2. 常駐アプリの実装**: `pystray` によるタスクトレイ常駐。
- **2.1.3. APIサーバーの実装**: `FastAPI` による別スレッドサーバー。

#### 2.2. スキャンロジック (Scanning Logic) [完了 - 検証済]
- **2.2.1. 動体検知**: OpenCVによる変化抽出。
- **2.2.2. Ecoモード実装**: 待機時低FPS切り替え。
- **2.2.3. 静止判定・撮影**: 1.5秒静止後の自動撮影。
- **検証内容**: Mockカメラを使用して、自動撮影と `./temp` へ の保存、APIでの検知を実機なしで確認済み。

#### 2.3. AI解析ロジック (AI Processing) [完了 - 検証済]
- **2.3.1. OCR連携 (EasyOCR)**: 撮影画像から患者IDを抽出するロジックの実装（Azure AI案から変更）。
- **2.3.2. 解析結果の紐付け**: 保存された画像と抽出IDのデータ管理。
- **検証内容**: Mockモードにて、キャプチャからID抽出までの連携フローを確認済み。
- [ ] **2.3.2. ダミーモード実装**
    - 開発中にAPI課金を防ぐため、ダミーIDを返すモック機能の実装。

### 1. API 接続テスト (AI連携)
`http://127.0.0.1:8000/check_new_scan` にて、画像キャプチャ後に自動でAI解析が走り、IDが返ることを確認しました。
- **Result**:
```json
{
  "new_file": true,
  "patient_id": "12345678",
  "file_url": "http://127.0.0.1:8000/files/scan_20260128_124742_be10a8eb.jpg",
  "filename": "scan_20260128_124742_be10a8eb.jpg"
}
```

### 3. 一気通貫テスト (End-to-End: 検索経由フロー)
「内部ID（PK）が不明」という電子カルテ固有の課題を、検索画面を自動操作することで解決しました。
- **Flow**: スキャン検知 -> 検索画面へ自動遷移 -> 患者ID入力 -> 自動検索実行 -> 患者個別ページ到達。
- **Result**: `mock_emr.html` を使用し、診察券IDから内部ID `2355092` のページへ自動的にたどり着くことを確認。

## Phase 2 完了のまとめ
プロトタイプ開発（Phase 2）の全実装項目が完了しました。
- [x] 常駐バックエンド基盤
- [x] 書類検知・自動撮影エンジン（Mock対応）
- [x] AIによるID抽出ロジック（Stub対応）
- [x] ブラウザ自動入力・検索ナビゲーション

## 次のステップ
**Phase 3: 本構築・機能拡張 (v0.3.0)** に移行します。
ここからは、実際のカメラやOCRを用いた実機テストと、設定画面などの実務向け機能の拡充を行っていきます。

#### 2.4. Chrome拡張機能 MVP (Frontend MVP) [完了 - 検証準備完了]
- **2.4.1. Manifest V3 基盤作成**: 雛形作成完了。
- **2.4.2. ポーリング実装**: 2秒おきのバックエンド確認ロジック実装。
- **2.4.3. ナビゲーション・自動入力の実装**:
    - `patient_id` に基づくURL動的生成（遷移）の実装。
    - 既存タブの再利用ロジックの実装。
    - 指定要素出現後の自動入力・ファイル選択擬似操作の実装。

#### 3.4. 実機動作検証 (Hardware Verification) [New]
- **3.4.1. 準備物 (Prerequisites)**:
    - [ ] **USB書画カメラ** (またはWebカメラ)
    - [ ] **テスト用診察券** (8桁以上の数字が印字されたカード)
    - [ ] **テスト用書類** (A4用紙など)
    - [ ] **照明環境** (文字が影で隠れない明るさ)
- **3.4.2. 検証シナリオ**:
    - [ ] **Case A: 診察券のみ** -> 1.5秒静止 -> 撮影 -> OCR成功 -> ログ確認
    - [ ] **Case B: 書類 + 診察券** -> 撮影 -> OCR成功 (診察券エリア認識)
    - [ ] **Case C: カメラスイッチ** -> タスクトレイからカメラ切り替え動作確認

#### 3.5. 検出精度・閾値の最適化 (Optimization) [New]
- 実機検証の結果に基づき、環境に合わせたチューニングを行います。
- [ ] **3.5.1. 動体検知パラメータ調整**:
    - `MIN_AREA_THRESHOLD` (面積閾値) の最適化。小さな動きで反応しすぎないように調整。
    - `MOTION_WAIT_TIME` (静止判定時間) の微調整。
- [ ] **3.5.2. 文書切り出し精度の向上**:
    - 背景と文書のコントラストが低い場合の輪郭抽出ロジック改善。
    - 矩形補正 (Perspective Transform) の安定化。
- [ ] **3.5.3. OCR前処理の強化**:
    - コントラスト強調、二値化などの画像処理フィルタを追加し、OCR認識率を向上させる。

---

## Phase 3: 本開発 (Development) - v0.5.0
**目標**: ユーザーが設定可能にし、エラー処理や使い勝手を製品レベルにする。

### 3.1. バックエンド機能拡張
- [ ] **3.1.1. 設定管理システムの実装**
    - `config_manager.py` の作成:
        - 環境変数 (`.env`) の読み書き機能
        - デフォルト値の管理
        - 設定変更時の動的リロード機能
    - 設定可能項目:
        - カメラインデックス
        - 動体検知閾値 (`MIN_AREA_THRESHOLD`, `MOTION_WAIT_TIME`)
        - Ecoモード待機時間
        - OCRエンジン選択 (EasyOCR/Tesseract)
        - Tesseractパス (オプション)
- [ ] **3.1.2. 設定API (`/settings`) の実装**
    - `GET /settings`: 現在の設定を JSON で返す
    - `POST /settings`: 設定を更新し、`.env` に書き込む
    - 設定変更後の自動再起動ロジック (カメラ再初期化など)
- [ ] **3.1.3. 振り分けロジックの実装**
    - 面積・個数判定による「受付モード」と「文書モード」の自動判定:
        - カードサイズ (小面積) → 受付モード
        - A4サイズ (大面積) → 文書モード
    - 音声通知機能の実装:
        - `winsound.Beep()` または `pygame.mixer` を使用
        - 「受付しました」「スキャン完了」などの音声フィードバック

### 3.2. タスクトレイ・メニュー完成
- [x] **3.2.1. カメラ選択メニュー** (実装済み)
    - 利用可能カメラ一覧の動的生成と切り替え処理
    - 空リスト時のフォールバック表示
- [ ] **3.2.2. Ecoモード設定メニュー**
    - サブメニューで待機時間を選択 (5秒/10秒/30秒/無効)
    - 選択時に設定APIを呼び出して永続化
- [ ] **3.2.3. ステータス表示の改善**
    - 現在のモード (ACTIVE/ECO) をアイコンまたはメニューテキストで表示
    - 最終スキャン時刻の表示

### 3.3. Chrome拡張機能 UI実装
- [ ] **3.3.1. 設定ページ (Options UI) の実装**
    - `extension/options.html` + `options.js` の作成
    - 設定項目:
        - 電子カルテURL (受付ページ、カルテページ)
        - CSSセレクタ (検索入力、ファイルアップロード)
        - バックエンドURL (デフォルト: `http://127.0.0.1:8000`)
    - `chrome.storage.sync` への保存機能
- [ ] **3.3.2. かんたん設定ウィザードの実装**
    - `interactive_setup.js` の作成:
        - ユーザーが画面上の要素をクリックすると、そのCSSセレクタを自動取得
        - ステップバイステップのガイド表示
        - 設定完了後、自動的に `chrome.storage` に保存
- [ ] **3.3.3. 手入力モーダルの実装**
    - OCR失敗時に表示するオーバーレイUI:
        - スキャンした画像のプレビュー表示
        - 患者ID入力フォーム
        - 送信ボタン → バックエンドに手動IDを送信
    - `extension/manual_input.html` + `manual_input.js` の作成

---

## Phase 4: 検証・リリース (Verification & Release) - v1.0.0
**目標**: 安定性の確保と配布準備。

### 4.1. 結合テスト
- [ ] **4.1.1. End-to-End テスト (正常系)**
    - **シナリオ1: 診察券スキャン → 受付登録**
        1. 診察券をカメラ下に配置
        2. 1.5秒静止 → 自動撮影
        3. OCRで患者ID抽出成功
        4. Chrome拡張が検知 → 受付ページへ自動遷移
        5. ID入力 → 検索 → 患者情報表示
    - **シナリオ2: 書類スキャン → カルテ添付**
        1. 書類 + 診察券を配置
        2. 撮影 → OCR成功
        3. Chrome拡張が検知 → カルテページへ遷移
        4. ファイルタブ → アップロードモーダル → 自動添付
        5. 完了通知表示
- [ ] **4.1.2. 異常系テスト**
    - **ケース1: OCR認識失敗**
        - 手書き文字や不鮮明な画像 → 手入力モーダル表示 → 手動ID入力 → 正常処理
    - **ケース2: ネットワーク切断**
        - バックエンドAPI接続失敗 → Chrome拡張がエラー通知 → リトライロジック動作確認
    - **ケース3: カメラ切断**
        - USB抜去 → アプリがエラーログ出力 → 再接続時の自動復帰確認
    - **ケース4: 電子カルテ画面変更**
        - セレクタ不一致 → エラー通知 → 設定ウィザードへの誘導
- [ ] **4.1.3. パフォーマンステスト**
    - 連続スキャン (10枚) → メモリリーク確認
    - 長時間稼働 (8時間) → 安定性確認

### 4.2. 配布準備
- [ ] **4.2.1. インストーラー整備**
    - `install.bat` の改善:
        - Pythonインストール有無の自動チェック
        - Dドライブ容量チェック (最低5GB必要)
        - スタートアップ登録オプション
    - `uninstall.bat` の作成:
        - 仮想環境の削除
        - スタートアップ登録の解除
- [ ] **4.2.2. マニュアル作成**
    - **インストールガイド** (`Manual/install_guide.md`):
        - システム要件 (Windows 10/11, Python 3.8+, 空き容量5GB)
        - インストール手順 (スクリーンショット付き)
        - Chrome拡張機能のインストール手順
    - **ユーザーマニュアル** (`Manual/user_manual.md`) の更新:
        - 日々の使い方
        - トラブルシューティング (FAQ)
        - 設定変更方法
    - **開発者向けドキュメント** (`documents/developer_guide.md`):
        - アーキテクチャ概要
        - API仕様
        - カスタマイズ方法
- [ ] **4.2.3. リリースパッケージ作成**
    - バージョン番号の付与 (v1.0.0)
    - CHANGELOG.md の作成
    - GitHub Release の作成
    - 配布用ZIPファイルの作成 (必要ファイルのみ)
