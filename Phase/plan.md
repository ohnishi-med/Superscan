# 開発計画 (Development Plan)

プロジェクトのフェーズ定義と詳細タスクリストです。
各タスクは `Phase X.Y.Z` の粒度で管理し、実装時の迷いを排除します。

## Phase 1: 企画・設計 (Planning) - v0.1.0 [COMPLETED]
- [x] **1.1. 要件定義**
    - [x] 1.1.1. システム仕様書 (`system_spec.md`) の作成（日本語化・詳細化）
    - [x] 1.1.2. デュアルモード（自動受付/文書スキャン）の振り分けロジック定義
- [x] **1.2. 技術選定**
    - [x] 1.2.1. Pythonバックエンド構成決定 (FastAPI, pystray, OpenCV)
    - [x] 1.2.2. Chrome拡張機能構成決定 (Manifest V3)
- [x] **1.3. UI/UX設計**
    - [x] 1.3.1. タスクトレイ・メニューの仕様策定
    - [x] 1.3.2. 拡張機能設定画面・ウィザード機能の仕様策定

---

## Phase 2: プロトタイプ開発 (Prototyping MVP) - v0.2.0
**目標**: 「設定不要で、起動すればスキャンして電子カルテにアップロードされる」コア機能の動作実証。

### 2.1. バックエンド基盤構築 (Backend Foundation)
- [ ] **2.1.1. Pythonプロジェクトセットアップ**
    - `venv` 作成、`requirements.txt` 定義 (fastapi, uvicorn, opencv-python, pystray, pillow, easyocr, python-dotenv, **cv2-enumerate-cameras**)。
- [ ] **2.1.2. タスクトレイ常駐アプリの実装**
    - `pystray` を使用し、起動時にアイコンを表示。
    - 「終了」メニューの実装。コンソールウィンドウなしでの起動 (`.pyw` 拡張子等) 検証。
> **Status**: [進行中] 2.1, 2.2 完了 (検証済み)

#### 2.1. バックエンド基盤 (Backend Foundation) [完了 - 検証済]
- **2.1.1. プロジェクト構成**: `venv`, `requirements.txt` の整備。
- **2.1.2. 常駐アプリの実装**: `pystray` によるタスクトレイ常駐。
- **2.1.3. APIサーバーの実装**: `FastAPI` による別スレッドサーバー。

#### 2.2. スキャンロジック (Scanning Logic) [完了 - 検証済]
- **2.2.1. 動体検知**: OpenCVによる変化抽出。
- **2.2.2. Ecoモード実装**: 待機時低FPS切り替え。
- **2.2.3. 静止判定・撮影**: 1.5秒静止後の自動撮影。
- **検証内容**: Mockカメラを使用して、自動撮影と `./temp` へ の保存、APIでの検知を実機なしで確認済み。

#### 2.3. AI解析ロジック (AI Processing) [完了 - 検証済]
- **2.3.1. OCR連携 (EasyOCR)**: 撮影画像から患者IDを抽出するロジックの実装（Azure AI案から変更）。
- **2.3.2. 解析結果の紐付け**: 保存された画像と抽出IDのデータ管理。
- **検証内容**: Mockモードにて、キャプチャからID抽出までの連携フローを確認済み。
- [ ] **2.3.2. ダミーモード実装**
    - 開発中にAPI課金を防ぐため、ダミーIDを返すモック機能の実装。

### 1. API 接続テスト (AI連携)
`http://127.0.0.1:8000/check_new_scan` にて、画像キャプチャ後に自動でAI解析が走り、IDが返ることを確認しました。
- **Result**:
```json
{
  "new_file": true,
  "patient_id": "12345678",
  "file_url": "http://127.0.0.1:8000/files/scan_20260128_124742_be10a8eb.jpg",
  "filename": "scan_20260128_124742_be10a8eb.jpg"
}
```

### 3. 一気通貫テスト (End-to-End: 検索経由フロー)
「内部ID（PK）が不明」という電子カルテ固有の課題を、検索画面を自動操作することで解決しました。
- **Flow**: スキャン検知 -> 検索画面へ自動遷移 -> 患者ID入力 -> 自動検索実行 -> 患者個別ページ到達。
- **Result**: `mock_emr.html` を使用し、診察券IDから内部ID `2355092` のページへ自動的にたどり着くことを確認。

## Phase 2 完了のまとめ
プロトタイプ開発（Phase 2）の全実装項目が完了しました。
- [x] 常駐バックエンド基盤
- [x] 書類検知・自動撮影エンジン（Mock対応）
- [x] AIによるID抽出ロジック（Stub対応）
- [x] ブラウザ自動入力・検索ナビゲーション

## 次のステップ
**Phase 3: 本構築・機能拡張 (v0.3.0)** に移行します。
ここからは、実際のカメラやOCRを用いた実機テストと、設定画面などの実務向け機能の拡充を行っていきます。

#### 2.4. Chrome拡張機能 MVP (Frontend MVP) [完了 - 検証準備完了]
- **2.4.1. Manifest V3 基盤作成**: 雛形作成完了。
- **2.4.2. ポーリング実装**: 2秒おきのバックエンド確認ロジック実装。
- **2.4.3. ナビゲーション・自動入力の実装**:
    - `patient_id` に基づくURL動的生成（遷移）の実装。
    - 既存タブの再利用ロジックの実装。
    - 指定要素出現後の自動入力・ファイル選択擬似操作の実装。

---

## Phase 3: 本開発 (Development) - v0.5.0
**目標**: ユーザーが設定可能にし、エラー処理や使い勝手を製品レベルにする。

### 3.1. バックエンド機能拡張
- [ ] **3.1.1. 設定APIの実装**
    - `.env` の読み書き機能、または `config.json` 管理への移行検討。
- [ ] **3.1.2. 振り分けロジックの実装**
    - 面積・個数判定による「受付モード」と「文書モード」の自動判定ロジック。
    - 音声通知機能 (`winsound` または `pygame` 等) の実装。

### 3.2. タスクトレイ・メニュー完成
- [ ] **3.2.1. カメラ選択メニュー**
    - 利用可能カメラ一覧の動的生成と切り替え処理。
- [ ] **3.2.2. Ecoモード設定メニュー**
    - 待機時間の変更機能。

### 3.3. Chrome拡張機能 UI実装
- [ ] **3.3.1. 設定ページ (Options UI) の実装**
    - 電子カルテURL、セレクタの設定フォーム。
- [ ] **3.3.2. かんたん設定ウィザード**
    - 画面上の要素クリックでセレクタを取得する `interactive_setup.js` の実装。
- [ ] **3.3.3. 手入力モーダル**
    - エラー時の画像表示とInputフォームのオーバーレイ実装。

---

## Phase 4: 検証・リリース (Verification & Release) - v1.0.0
**目標**: 安定性の確保と配布準備。

### 4.1. 結合テスト
- [ ] **4.1.1. End-to-End テスト**
    - 実際の紙を置いてから、電子カルテ画面に反映されるまでの通しテスト。
- [ ] **4.1.2. 異常系テスト**
    - ネット切断時、カメラ切断時、OCR認識失敗時の挙動確認。

### 4.2. 配布準備
- [ ] **4.2.1. 起動スクリプト整備**
    - `install.bat` (依存ライブラリインストール + スタートアップ登録)。
    - `start.bat` (アプリ起動)。
- [ ] **4.2.2. マニュアル作成**
    - インストール手順書、トラブルシューティング。
